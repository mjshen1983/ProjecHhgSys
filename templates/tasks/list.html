{% extends 'base.html' %}

{% block title %}任务列表{% endblock %}

{% block content %}
<div class="list-toolbar">
    <h1>任务看板</h1>
    <div class="action-group">
        <a class="header__button" href="{% url 'project_list' %}">返回项目列表</a>
        {% if can_manage_tasks %}
        <a class="primary-button" href="{% url 'task_create' %}?next={{ task_list_url|urlencode }}">新建任务</a>
        {% else %}
        <button type="button" class="primary-button primary-button--disabled" disabled>新建任务</button>
        {% endif %}
    </div>
</div>
<div class="table-card">
    <table>
        <thead>
            <tr><th>ID</th><th>项目</th><th>任务标题</th><th>优先级</th><th>状态</th><th>负责人</th><th>操作</th></tr>
        </thead>
        <tbody>
        {% for task in tasks %}
            <tr>
                <td>{{ task.id }}</td>
                <td>{{ task.project.code }}</td>
                <td>{{ task.title }}</td>
                <td><span class="priority-badge {{ task.priority_css }}">{{ task.priority_label }}</span></td>
                <td><span class="status-badge {{ task.status_css }}">{{ task.status_label }}</span></td>
                <td>{{ task.assignee.display_name|default:task.assignee.username|default:"--" }}</td>
                <td>
                    <div class="action-group">
                        <a class="header__button" href="{% url 'task_detail' task.id %}?next={{ task_list_url|urlencode }}">查看</a>
                        {% if can_manage_tasks or can_edit_all_tasks or task.assignee_id == user_id %}
                        <a class="header__button" href="{% url 'task_update' task.id %}?next={{ task_list_url|urlencode }}">修改</a>
                        {% else %}
                        <span class="header__button header__button--disabled" aria-disabled="true">修改</span>
                        {% endif %}
                        {% if can_manage_tasks %}
                        <form action="{% url 'task_delete' task.id %}" method="post" class="inline-form" onsubmit="return confirm('确定删除该任务？');">
                            {% csrf_token %}
                            <input type="hidden" name="next" value="{{ task_list_url }}">
                            <button type="submit" class="header__button header__button--danger">删除</button>
                        </form>
                        {% else %}
                        <span class="header__button header__button--disabled" aria-disabled="true">删除</span>
                        {% endif %}
                    </div>
                </td>
            </tr>
        {% empty %}
            <tr><td colspan="7">暂无任务，点击右上角按钮添加新任务。</td></tr>
        {% endfor %}
        </tbody>
    </table>
</div>
{% endblock %}